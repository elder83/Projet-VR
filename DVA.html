<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DVA — v7.2 (validation par ligne + métronome + export Excel)</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--line:#1f2937;--accent:#06b6d4;--ok:#34d399;--warn:#f59e0b;--err:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:10px 14px;border-bottom:1px solid var(--line);background:var(--panel)}
    header h1{margin:0;font-size:18px}
    header .sub{color:var(--muted);font-size:12px}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:12px;min-height:calc(100% - 54px)}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;grid-template-rows:auto 1fr}}
    .side{padding:12px;background:#0a1222;border-right:1px solid var(--line)}
    .main{padding:12px}
    .card{background:#0a1222;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:grid;gap:6px}
    input,select,button,textarea{border-radius:10px;border:1px solid #243045;background:#071021;color:#e2e8f0;padding:10px;font-size:14px}
    input[type=number]{width:120px}
    button{cursor:pointer}
    .btn.primary{background:#0ea5e9;border:0}
    .btn.ghost{background:transparent;border:1px solid #334155}
    .btn.ok{background:linear-gradient(90deg,#10b981,#22d3ee);border:0}
    .btn.stop{background:#ef4444;border:0}
    #stage{position:relative;height:65vh;min-height:360px;border:1px solid var(--line);border-radius:14px;background:#00070f;display:flex;align-items:center;justify-content:center}
    #status{position:absolute;top:8px;left:8px;font-size:12px;color:var(--muted)}
    #optoline{font-weight:900;letter-spacing:2px;line-height:1;text-align:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{color:#cbd5e1}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;background:#091126;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#cbd5e1}
    #debug{position:absolute;top:8px;right:8px}
    #err{display:none;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <h1>DVA — v7.2 (validation par LIGNE) <span class="sub">Une ligne = un verdict (VRAI/FAUX) • Descente auto si VRAI • Métronome • Export Excel</span></h1>
  </header>

  <div class="wrap">
    <aside class="side">
      <div class="card">
        <strong>Paramètres</strong>
        <div class="row">
          <label>Distance (m)
            <input id="distM" type="number" step="0.1" value="3" />
          </label>
          <label>Pixels/cm
            <input id="pxcm" type="number" step="0.1" value="37" />
          </label>
        </div>
        <div class="row">
          <label>Optotypes
            <select id="charset">
              <option value="ETDRS" selected>ETDRS</option>
              <option value="SLOAN">Sloan</option>
              <option value="LANDOLT">Landolt C</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Départ (logMAR)
            <input id="logStart" type="number" step="0.1" value="0.7" />
          </label>
          <label>Pas (logMAR)
            <input id="logStep" type="number" step="0.1" value="0.1" />
          </label>
          <label>Plan
            <select id="plane"><option value="H" selected>Horizontal</option><option value="V">Vertical</option></select>
          </label>
        </div>
        <div class="row">
          <button class="btn" id="btnStatic">VA statique</button>
          <button class="btn primary" id="btnDynamic">DVA</button>
          <button class="btn ghost" id="btnFullscreen">Plein écran</button>
        </div>
        <div class="row">
          <label>BPM métronome<input id="bpm" type="number" step="1" value="120"></label>
          <button class="btn ghost" id="btnMetro">Métronome</button>
          <span id="metroStat" class="pill">Metro: <em>off</em></span>
        </div>
        <div class="row">
          <button class="btn ok" id="btnLineOK">Ligne LUE (VRAI)</button>
          <button class="btn stop" id="btnLineKO">Ligne NON lue (FAUX)</button>
          <button class="btn ghost" id="btnExport">Exporter Excel</button>
        </div>
        <small class="pill">Raccourcis : <b>Entrée</b>=VRAI • <b>Échap</b>=FAUX</small>
      </div>

      <div class="card">
        <strong>Résultats</strong>
        <table>
          <thead><tr><th>Type</th><th>Plan</th><th>logMAR</th><th>Ligne</th><th>Verdict</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="row" style="justify-content:space-between">
          <div>VA statique: <b id="vaS">–</b></div>
          <div>DVA: <b id="vaD">–</b></div>
          <div>Δ lignes: <b id="loss">–</b></div>
        </div>
      </div>

      <div id="err" class="card">
        <strong>Erreur</strong>
        <div id="errmsg" style="color:#fca5a5"></div>
      </div>
    </aside>

    <main class="main">
      <div id="stage" tabindex="0">
        <div id="status"></div>
        <div id="debug" class="pill">Niveau: <b>—</b> logMAR</div>
        <div id="optoline"></div>
      </div>

      <div class="card">
        <strong>Principe & normes (littérature clinique)</strong>
        <ol>
          <li>Affiche une <b>ligne de 5 lettres</b> à un niveau logMAR donné.</li>
          <li>Décide <b>VRAI</b> (ligne lue correctement selon ton critère — p.ex. ≥<b>4/5</b>) ou <b>FAUX</b>.</li>
          <li><b>Si VRAI</b> ➜ on <b>diminue</b> le logMAR d’un <b>pas</b> (lettres plus petites) et on continue. <b>Si FAUX</b> ➜ on <b>arrête</b> et on fixe la <b>VA</b> à la dernière ligne passée.</li>
        </ol>
        <ul>
          <li><b>Seuil d’anormalité</b> : <u>Δ ≥ 2 lignes ETDRS/Snellen</u> (≈ <u>≥ 0,2–0,3 logMAR</u>) entre statique et dynamique ⇒ <b>VOR anormal probable</b>.</li>
          <li><b>Cadence</b> : horizontal ≈ <b>120 bpm</b> (~2 Hz), vertical <b>100–120 bpm</b>.</li>
          <li><b>Amplitude cible</b> : ~<b>20°</b> de chaque côté en H (~40° p‑à‑p), <b>15–20°</b> en V.</li>
          <li><b>Distance</b> : <b>3 m</b> de référence, <b>1 m</b> si espace réduit (noter la distance).</li>
        </ul>
      </div>
    </main>
  </div>

  <script>
  (function(){
    // --- helpers
    function $(s){return document.querySelector(s)}
    function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a}
    function fmt(n){return (Math.round(n*100)/100).toString()}
    function showError(e){ var box=$('#err'), msg=$('#errmsg'); if(box&&msg){ box.style.display='block'; msg.textContent=(e&&e.message)?e.message:String(e);} console.error(e); }

    // --- state
    var SLOAN=['C','D','H','K','N','O','R','S','V','Z'];
    var ETDRS=['C','D','E','F','L','O','P','T','Z'];
    var LAND=['↑','→','↓','←'];
    var STATE={pxcm:37,distM:3,mode:'idle',start:0.7,step:0.1,plane:'H',results:[],vaS:null,vaD:null,lastPassed:null};

    // --- geometry & rendering
    function pxForLogMAR(logmar){ var MAR=Math.pow(10,logmar); var arcmin=5*MAR; var rad=(arcmin/60)*(Math.PI/180); var phys_m=Math.tan(rad)*STATE.distM; return phys_m*100*STATE.pxcm; }
    function pool(){ var v=$('#charset').value; if(v==='ETDRS') return ETDRS; if(v==='SLOAN') return SLOAN; return LAND; }
    function makeLine(){ var set=pool(); if(set===LAND){ var pick=function(){return LAND[rnd(0,LAND.length-1)]}; return pick()+" "+pick()+" "+pick()+" "+pick()+" "+pick(); }
      var pick=function(){return set[rnd(0,set.length-1)]}; var L=[]; while(L.length<5){ var c=pick(); if(L.length>=2 && L[L.length-1]===c && L[L.length-2]===c) continue; L.push(c);} return L.join(' ');
    }
    function showLine(logmar){ var el=$('#optoline'); var px=pxForLogMAR(logmar); el.style.fontSize=Math.max(12,px)+'px'; el.textContent=makeLine(); $('#debug').innerHTML='Niveau: <b>'+fmt(logmar)+'</b> logMAR'; }

    function appendRow(row){ STATE.results.push(row); var tb=$('#tbody'); var tr=document.createElement('tr'); tr.innerHTML='<td>'+row.type+'</td><td>'+row.plane+'</td><td>'+fmt(row.logmar)+'</td><td>'+row.lineIndex+'</td><td>'+(row.pass?'VRAI':'FAUX')+'</td>'; tb.appendChild(tr); }

    // --- protocol (line-level)
    function run(type){
      try{
        STATE.mode=type; $('#status').innerHTML='Mode: <b>'+type+'</b> • Plan: <b>'+$('#plane').value+'</b>';
        var start=+$('#logStart').value; var step=+$('#logStep').value; var plane=$('#plane').value;
        var level=start; STATE.lastPassed=null; showLine(level); $('#stage').focus();

        function verdict(pass){ // pass=true -> descendre; false -> arrêter et fixer VA
          appendRow({type:type, plane:plane, logmar:level, lineIndex:Math.max(1, Math.round((start-level)/step)+1), pass:pass});
          if(pass){ STATE.lastPassed=level; level=+(level-step).toFixed(3); showLine(level); }
          else { // arrêt
            var va = (STATE.lastPassed!=null)? STATE.lastPassed : (level+step); // si première ligne échouée → VA = ligne précédente
            if(type==='static') STATE.vaS=va; else STATE.vaD=va; $('#vaS').textContent=(STATE.vaS!=null?fmt(STATE.vaS):'–'); $('#vaD').textContent=(STATE.vaD!=null?fmt(STATE.vaD):'–');
            if(STATE.vaS!=null && STATE.vaD!=null){ var loss=Math.round((STATE.vaD-STATE.vaS)/step); $('#loss').textContent=loss + ' ligne' + (loss>1?'s':''); }
            STATE.mode='idle'; $('#status').innerHTML='Mode: <b>idle</b>';
          }
        }

        // boutons & clavier
        $('#btnLineOK').onclick=function(){ verdict(true) };
        $('#btnLineKO').onclick=function(){ verdict(false) };
        window.onkeydown=function(e){ if(STATE.mode==='idle') return; if(e.key==='Enter'){ verdict(true); e.preventDefault(); } else if(e.key==='Escape'){ verdict(false); e.preventDefault(); } };
      }catch(e){ showError(e); }
    }

    // Métronome (BPM configurable)
    function setupMetronome(){
      var ctx=null, timer=null, on=false, tick=false;
      function beep(){
        var osc=ctx.createOscillator(); var g=ctx.createGain(); osc.connect(g); g.connect(ctx.destination);
        osc.frequency.value = tick?880:660; tick=!tick;
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.07);
        osc.start(); osc.stop(ctx.currentTime+0.08);
      }
      function start(){ try{ ctx = new (window.AudioContext||window.webkitAudioContext)(); var interval=60/(+($('#bpm').value||120)); on=true; $('#metroStat').innerHTML='Metro: <b>on</b>'; timer=setInterval(function(){ if(!on){clearInterval(timer); return;} beep(); }, interval*1000);}catch(e){ showError(e); } }
      function stop(){ on=false; $('#metroStat').innerHTML='Metro: <em>off</em>'; }
      $('#btnMetro').addEventListener('click', function(){ on?stop():start(); });
      $('#bpm').addEventListener('change', function(){ if(on){ stop(); start(); }});
    }

    // Export Excel (.xls via HTML de table lisible par Excel)
    function exportExcel(){
      try{
        var now=new Date();
        var fileName='DVA_export_'+ now.toISOString().slice(0,19).replace(/[:T]/g,'-') +'.xls';
        var esc=function(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')};

        // Tableau Mesures
        var rows=STATE.results.map(function(r){
          return '<tr>'+[
            esc(r.type), esc(r.plane), esc(fmt(r.logmar)), esc(r.lineIndex), esc(r.pass?'VRAI':'FAUX')
          ].map(function(td){return '<td>'+td+'</td>'}).join('') + '</tr>';
        }).join('');
        var table1='\n<table border="1">\n'+
          '<tr style="background:#e2e8f0"><th>Type</th><th>Plan</th><th>logMAR</th><th>Ligne</th><th>Verdict</th></tr>'+
          rows+'\n</table>';

        // Tableau Résumé
        var vaS=STATE.vaS!=null?fmt(STATE.vaS):''; var vaD=STATE.vaD!=null?fmt(STATE.vaD):'';
        var step=+($('#logStep').value||0.1);
        var loss=(STATE.vaS!=null&&STATE.vaD!=null)? Math.round((STATE.vaD-STATE.vaS)/step):'';
        var table2='\n<table border="1">\n'+
          '<tr style="background:#e2e8f0"><th>Champ</th><th>Valeur</th></tr>'+
          '<tr><td>Distance (m)</td><td>'+esc(STATE.distM)+'</td></tr>'+
          '<tr><td>Pixels/cm</td><td>'+esc(STATE.pxcm)+'</td></tr>'+
          '<tr><td>VA statique (logMAR)</td><td>'+esc(vaS)+'</td></tr>'+
          '<tr><td>DVA (logMAR)</td><td>'+esc(vaD)+'</td></tr>'+
          '<tr><td>Δ lignes</td><td>'+esc(loss)+'</td></tr>'+
          '</table>';

        var html='<!DOCTYPE html><html><head><meta charset="utf-8">'+
          '<meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">'+
          '<title>Export DVA</title>'+ 
          '<style>table{border-collapse:collapse} td,th{padding:6px;border:1px solid #999; font-family:Segoe UI,Arial,sans-serif; font-size:12px}</style>'+ 
          '</head><body>'+ 
          '<h3>Mesures DVA</h3>'+ table1 + 
          '<h3>Résumé</h3>'+ table2 + 
          '<p><em>Seuil d’anormalité : Δ ≥ 2 lignes (≈ ≥ 0,2–0,3 logMAR).</em></p>'+ 
          '</body></html>';

        var blob=new Blob([html],{type:'application/vnd.ms-excel;charset=utf-8;'});
        var url=URL.createObjectURL(blob); var a=document.createElement('a');
        a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);
      }catch(e){ showError(e); }
    }

    function bind(){
      $('#btnStatic').addEventListener('click',function(){ run('static') });
      $('#btnDynamic').addEventListener('click',function(){ run('dynamic') });
      $('#btnFullscreen').addEventListener('click',function(){ var el=document.documentElement; if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });
      $('#btnExport').addEventListener('click', exportExcel);
      ['distM','pxcm','logStart','logStep','plane','charset'].forEach(function(id){ var el=document.getElementById(id); el.addEventListener('change',function(){ STATE.distM=+$('#distM').value; STATE.pxcm=+$('#pxcm').value; STATE.start=+$('#logStart').value; STATE.step=+$('#logStep').value; STATE.plane=$('#plane').value; }); });
    }

    window.addEventListener('DOMContentLoaded', function(){ try{ STATE.distM=+$('#distM').value; STATE.pxcm=+$('#pxcm').value; STATE.start=+$('#logStart').value; STATE.step=+$('#logStep').value; bind(); setupMetronome(); }catch(e){ showError(e); } });

  })();
  </script>
</body>
</html>
